{% extends 'trackingtalibe/base.html' %}
{% block title %}Suivi de {{ enfant.nom }} {{ enfant.prenom }}{% endblock %}

{% block content %}
<h4 class="text-center" style="margin-top: 60px;">Suivi de {{ enfant.nom }} {{ enfant.prenom }}</h4>

<div id="map" style="height: 500px; border: 2px solid #ccc; margin-bottom: 4rem; width: 100%;"></div>

<script>
    var enfantId = {{ enfant.id }};
    var map = L.map('map').setView([14.69234, -16.46627], 18);

    // üó∫Ô∏è Tuile satellite Mapbox
    L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
        id: 'mapbox/satellite-streets-v12',
        tileSize: 512,
        zoomOffset: -1,
        maxZoom: 22,
        accessToken: 'pk.eyJ1Ijoic2xkMDciLCJhIjoiY21iNzd6czAxMDdxYjJqczFiOWgxajI0biJ9.cT9ueN4meMGQFRMZ6Q5GJg',
        attribution: '¬© <a href="https://www.mapbox.com/">Mapbox</a>'
    }).addTo(map);

    // üìç Ic√¥ne enfant
    var enfantIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32]
    });

    var marker = L.marker([14.69234, -16.46627], { icon: enfantIcon }).addTo(map);
    marker.bindPopup("{{ enfant.nom }} {{ enfant.prenom }}").openPopup();

    var currentLatLng = marker.getLatLng();
    var targetLatLng = currentLatLng;
    var animating = false;
    var userCircle = null;
    var traceLine = null;

    // üè† Ic√¥ne Daara
    var daaraIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/69/69524.png',
        iconSize: [36, 36],
        iconAnchor: [18, 36],
        popupAnchor: [0, -36]
    });

    var daaraCoords = [14.692425, -16.466784];  // ‚ö†Ô∏è Personnaliser
    var daaraMarker = L.marker(daaraCoords, { icon: daaraIcon }).addTo(map);
    daaraMarker.bindPopup("Daara {{ user.nom_daara }}");

    var cercleSecurite = L.circle(daaraCoords, {
        color: 'red',
        fillColor: '#f03',
        fillOpacity: 0.2,
        radius: 1200  // m√®tres
    }).addTo(map);

    // Fonction d‚Äôinterpolation
    function interpolatePosition(start, end, factor) {
        return [
            start.lat + (end.lat - start.lat) * factor,
            start.lng + (end.lng - start.lng) * factor
        ];
    }

    function animateMarker() {
        if (!animating) return;
        currentLatLng = marker.getLatLng();
        let interpolated = interpolatePosition(currentLatLng, targetLatLng, 0.2);
        marker.setLatLng(interpolated);
        marker.update();
        map.panTo(interpolated, { animate: true, duration: 0.5 });

        if (Math.abs(interpolated[0] - targetLatLng.lat) > 0.00001 || Math.abs(interpolated[1] - targetLatLng.lng) > 0.00001) {
            requestAnimationFrame(animateMarker);
        }
    }

    // üö∂ Calcul d‚Äôitin√©raire via Mapbox Directions API
    function getRoute(userLatLng, enfantLatLng) {
        var accessToken = 'pk.eyJ1Ijoic2xkMDciLCJhIjoiY21iNzd6czAxMDdxYjJqczFiOWgxajI0biJ9.cT9ueN4meMGQFRMZ6Q5GJg';
        var url = `https://api.mapbox.com/directions/v5/mapbox/driving/${userLatLng.lng},${userLatLng.lat};${enfantLatLng.lng},${enfantLatLng.lat}?geometries=geojson&access_token=${accessToken}`;

        fetch(url)
            .then(res => res.json())
            .then(data => {
                if (data.routes && data.routes.length > 0) {
                    var coords = data.routes[0].geometry.coordinates;
                    var latlngs = coords.map(c => [c[1], c[0]]);  // lng, lat ‚Üí lat, lng

                    if (traceLine) {
                        traceLine.setLatLngs(latlngs);
                    } else {
                        traceLine = L.polyline(latlngs, { color: 'blue', weight: 4 }).addTo(map);
                    }
                }
            })
            .catch(err => {
                console.error("Erreur itin√©raire :", err);
            });
    }

    // Position utilisateur (point bleu)
    function updateUserLocation() {
        if (!navigator.geolocation) return;

        navigator.geolocation.getCurrentPosition(
            function(position) {
                var lat = position.coords.latitude;
                var lng = position.coords.longitude;
                var userLatLng = L.latLng(lat, lng);

                if (!userCircle) {
                    userCircle = L.circleMarker(userLatLng, {
                        radius: 8,
                        color: '#0d6efd',
                        fillColor: '#0d6efd',
                        fillOpacity: 1
                    }).addTo(map).bindPopup("Votre position");
                } else {
                    userCircle.setLatLng(userLatLng);
                }

                // Mettre √† jour la trace
                if (marker && marker.getLatLng()) {
                    getRoute(userLatLng, marker.getLatLng());
                }
            },
            function(error) {
                console.error("Erreur g√©olocalisation :", error);
            }
        );
    }

    // üõ∞Ô∏è Mise √† jour des coordonn√©es de l‚Äôenfant
    function updatePosition() {
        fetch(`/enfant/${enfantId}/position/?t=${Date.now()}`)
            .then(response => response.json())
            .then(data => {
                if (data.latitude && data.longitude) {
                    targetLatLng = L.latLng(data.latitude, data.longitude);
                    animating = true;
                    animateMarker();
                }
            })
            .catch(error => {
                console.error("Erreur de mise √† jour :", error);
            });

        updateUserLocation();
    }

    updatePosition();
    setInterval(updatePosition, 2000); // toutes les 2 secondes
</script>
{% endblock %}
