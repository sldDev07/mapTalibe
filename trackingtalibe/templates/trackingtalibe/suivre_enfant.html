{% extends 'trackingtalibe/base.html' %}
{% block title %}Suivi de {{ enfant.nom }} {{ enfant.prenom }}{% endblock %}

{% block content %}
<h4 class="text-center" style="margin-top: 60px;">Suivi de {{ enfant.prenom }} {{ enfant.nom }} </h4>

<div id="alerte-securite" class="alert alert-danger text-center fw-bold" style="display: none;">
    ‚ö†Ô∏è Alerte : {{ enfant.prenom }} {{ enfant.nom }}  est en dehors du p√©rim√®tre de s√©curit√© !
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<div id="map" class="container" style="height: 500px; border: 3px solid #050505; margin-bottom: 4rem; width: 80%;"></div>

<script>
    var enfantId = {{ enfant.id }};

    var enfantLat = parseFloat("{{ latitude }}");
    var enfantLon = parseFloat("{{ longitude }}");
    var daaraLat = parseFloat("{{ daara_latitude }}");
    var daaraLon = parseFloat("{{ daara_longitude }}");

    console.log("enfantLat:", enfantLat, "enfantLon:", enfantLon);
    console.log("daaraLat:", daaraLat, "daaraLon:", daaraLon);

    if (!isNaN(enfantLat) && !isNaN(enfantLon) && !isNaN(daaraLat) && !isNaN(daaraLon)) {
        var map = L.map('map').setView([enfantLat, enfantLon], 18);

        // üó∫Ô∏è Tuile satellite Mapbox
        L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}',{
            id: 'mapbox/satellite-streets-v12',
            tileSize: 512,
            zoomOffset: -1,
            maxZoom: 22,
            accessToken: '{{ MAPBOX_TOKEN }}',
            attribution: '¬© <a href="https://www.mapbox.com/">Mapbox</a>'
        }).addTo(map);

        // üìç Ic√¥ne enfant
        var enfantIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32]
        });

        var marker = L.marker([enfantLat, enfantLon], { icon: enfantIcon }).addTo(map);
        marker.bindPopup("{{ enfant.nom }} {{ enfant.prenom }}").openPopup();

        var currentLatLng = marker.getLatLng();
        var targetLatLng = currentLatLng;
        var animating = false;
        var userCircle = null;
        var traceLine = null;

        // üè† Ic√¥ne Daara
        var daaraIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/69/69524.png',
            iconSize: [36, 36],
            iconAnchor: [18, 36],
            popupAnchor: [0, -36]
        });

        // Correction ici : utilise bien les variables daaraLat et daaraLon
        var daaraCoords = [daaraLat, daaraLon];
        console.log("daaraCoords:", daaraCoords); // V√©rification
        var daaraMarker = L.marker(daaraCoords, { icon: daaraIcon }).addTo(map);
        daaraMarker.bindPopup("Daara {{ enfant.daara.nom }}");

        var cercleSecurite = L.circle(daaraCoords, {
            color: 'red',
            fillColor: '#f03',
            fillOpacity: 0.2,
            radius: {{ enfant.daara.rayon_securite_metres }}
        }).addTo(map);

        // Fonction d‚Äôinterpolation
        function interpolatePosition(start, end, factor) {
            return [
                start.lat + (end.lat - start.lat) * factor,
                start.lng + (end.lng - start.lng) * factor
            ];
        }

        function animateMarker() {
            if (!animating) return;
            currentLatLng = marker.getLatLng();
            let interpolated = interpolatePosition(currentLatLng, targetLatLng, 0.2);
            marker.setLatLng(interpolated);
            marker.update();
            map.panTo(interpolated, { animate: true, duration: 0.5 });

            if (Math.abs(interpolated[0] - targetLatLng.lat) > 0.00001 || Math.abs(interpolated[1] - targetLatLng.lng) > 0.00001) {
                requestAnimationFrame(animateMarker);
            }
        }

        // üö∂ Calcul d‚Äôitin√©raire via Mapbox Directions API
        function getRoute(userLatLng, enfantLatLng) {
            var accessToken = '{{ MAPBOX_TOKEN }}';
            var url = `https://api.mapbox.com/directions/v5/mapbox/walking/${userLatLng.lng},${userLatLng.lat};${enfantLatLng.lng},${enfantLatLng.lat}?geometries=geojson&access_token=${accessToken}`;

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (data.routes && data.routes.length > 0) {
                        var coords = data.routes[0].geometry.coordinates;
                        var latlngs = coords.map(c => [c[1], c[0]]);

                        if (traceLine) {
                            traceLine.setLatLngs(latlngs);
                        } else {
                            traceLine = L.polyline(latlngs, { color: 'blue', weight: 4 }).addTo(map);
                        }
                    }
                })
                .catch(err => {
                    console.error("Erreur itin√©raire :", err);
                });
        }

        // Position utilisateur (point bleu)
        function updateUserLocation() {
            if (!navigator.geolocation) return;

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    var lat = position.coords.latitude;
                    var lng = position.coords.longitude;
                    var userLatLng = L.latLng(lat, lng);

                    if (!userCircle) {
                        userCircle = L.circleMarker(userLatLng, {
                            radius: 8,
                            color: '#0d6efd',
                            fillColor: '#0d6efd',
                            fillOpacity: 1
                        }).addTo(map).bindPopup("Votre position");
                    } else {
                        userCircle.setLatLng(userLatLng);
                    }

                    // Mettre √† jour la trace
                    if (marker && marker.getLatLng()) {
                        getRoute(userLatLng, marker.getLatLng());
                    }
                },
                function(error) {
                    console.error("Erreur g√©olocalisation :", error);
                }
            );
        }

        // üõ∞Ô∏è Mise √† jour des coordonn√©es de l‚Äôenfant
        function updatePosition() {
        fetch(`/enfant/${enfantId}/position/?t=${Date.now()}`)
            .then(response => response.json())
            .then(data => {
                if (data.latitude && data.longitude) {
                    targetLatLng = L.latLng(data.latitude, data.longitude);
                    animating = true;
                    animateMarker();

                    // Distance entre enfant et Daara
                    var distance = map.distance(targetLatLng, daaraCoords); // en m√®tres
                    var dansZone = distance <= cercleSecurite.getRadius();

                    // üîÑ Mise √† jour du cercle
                    if (dansZone) {
                        cercleSecurite.setStyle({
                            color: 'green',
                            fillColor: '#5df58a'
                        });
                        document.getElementById('alerte-securite').style.display = 'none';
                    } else {
                        cercleSecurite.setStyle({
                            color: 'red',
                            fillColor: '#f03'
                        });
                        document.getElementById('alerte-securite').style.display = 'block';
                    }

                }
            })
            .catch(error => {
                console.error("Erreur de mise √† jour :", error);
            });

        updateUserLocation();
    }


        updatePosition();
        setInterval(updatePosition, 500);
    } else {
        document.getElementById('map').innerHTML = "<div class='alert alert-warning'>Position Indisponible pour le moment.</div>";
    }
</script>
{% endblock %}